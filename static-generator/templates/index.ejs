<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
  <title>Brutalist Report knock-off</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <div class="container">
    <div class="header">
      <div class="hero">
          <div class="hero-top">
            <div>
              <p class="eyebrow">Daily feed digest</p>
              <h1>What Happened, remixed</h1>
              <p class="updated-at">Last updated <%= new Date().toLocaleDateString('en-US', { weekday: 'long' , month:
                'long' , day: 'numeric' , year: 'numeric' , timeZone: 'UTC' }) %>
                <%= new Date().toLocaleTimeString('en-US', { hour: 'numeric' , minute: '2-digit' , hour12: true,
                  timeZone: 'UTC' }) %> (UTC).</p>
          </div>
          <div class="header-buttons">
            <button id="layoutToggle" class="layout-toggle" aria-pressed="false">List View</button>
            <button id="goodVibesToggle" class="good-vibes-toggle">Good Vibes Only</button>
            <button id="darkModeToggle" class="dark-mode-toggle">üåô</button>
          </div>
        </div>
        <p class="hero-subtitle">A clean, linear scroll of everything pulled from your feeds. No blocks, no rainbow
          grid‚Äîjust stacked stories with a hint of orange.</p>
      </div>
    </div>

    <div class="category-filter">
      <ul class="category-list">
        <li class="category-item all active" data-category="all">All</li>
        <% categories.forEach(function(category) { %>
          <li class="category-item" data-category="<%= category %>">
            <%= category.charAt(0).toUpperCase() + category.slice(1) %>
          </li>
          <% }); %>
      </ul>
      <div class="category-help">Click to select multiple categories. Click "All" to reset.</div>
    </div>

    <div class="report-section-wrapper">
      <div id="reportToggleContainer" class="report-toggle-container hidden"></div>
      <div id="reportContainer" class="report-container hidden">
        <% if (reports && reports.length> 0) { %>
          <% reports.forEach(function(report) { %>
            <div class="category-report hidden" data-category="<%= report.category %>">
              <div class="report-content">
                <% if (report.report) { %>
                  <div class="report-header">
                    <p class="report-intro">
                      <%= report.report.header %>
                    </p>
                  </div>

                  <div class="report-section">
                    <h3>Main Stories</h3>
                    <% report.report.mainStories.forEach(function(story) { %>
                      <div class="story-item">
                        <div class="story-tag">
                          <%= story.sectionTag %>
                        </div>
                        <h4><a href="<%= story.sourceUrl %>" target="_blank">
                            <%= story.headline %>
                          </a></h4>
                        <div class="story-source">Source: <%= story.sourceName %>
                        </div>

                        <div class="story-details">
                          <p><strong>What Happened:</strong>
                            <%= story.whatHappened %>
                          </p>
                          <p><strong>Why It Matters:</strong>
                            <%= story.whyItMatters %>
                          </p>
                          <div class="impact-section">
                            <p><strong>Short-Term:</strong>
                              <%= story.shortTermImpact %>
                            </p>
                            <p><strong>Long-Term:</strong>
                              <%= story.longTermImpact %>
                            </p>
                          </div>
                          <div class="story-sentiment <%= story.sentiment.toLowerCase() %>">
                            <strong>Sentiment:</strong>
                            <%= story.sentiment %> - <%= story.sentimentRationale %>
                          </div>
                        </div>
                      </div>
                      <% }); %>
                  </div>

                  <div class="report-section">
                    <h3>What Else Is Going On</h3>
                    <ul class="what-else-list">
                      <% report.report.whatElseIsGoingOn.forEach(function(item) { %>
                        <li>
                          <%= item.text %>
                            <span class="source-link">(<a href="<%= item.sourceUrl %>" target="_blank">
                                <%= item.sourceName %>
                              </a>)</span>
                        </li>
                        <% }); %>
                    </ul>
                  </div>

                  <% if (report.report.byTheNumbers) { %>
                    <div class="report-section by-the-numbers">
                      <h3>By The Numbers</h3>
                      <div class="number-display">
                        <span class="big-number">
                          <%= report.report.byTheNumbers.number %>
                        </span>
                        <span class="number-commentary">
                          <%= report.report.byTheNumbers.commentary %>
                        </span>
                      </div>
                    </div>
                    <% } %>

                      <div class="report-footer">
                        <p class="sign-off">
                          <%= report.report.signOff %>
                        </p>
                      </div>
                      <% } else { %>
                        <p>Report content unavailable.</p>
                        <% } %>
              </div>
              <div class="report-meta">
                Generated at <%= formatDate(new Date(report.generatedAt)) %>
              </div>
            </div>
            <% }); %>
              <% } %>
                <div id="noReportMessage" class="category-report hidden">
                  <p>No report available for this category.</p>
                </div>
      </div>
    </div>

    <div class="feeds-container">
      <% feeds.forEach(function(feed) { %>
        <div class="feed" data-categories="<%= feed.categories.map(cat => encodeURIComponent(cat)).join(' ') %>">
          <div class="feed-header">
            <div class="feed-title">
              <a href="<%= feedMetadata[feed.id]?.siteUrl || feed.url.replace(/\/rss\/?.*$|\.rss$|\/feed\/?.*$|\.xml$/, '/') %>"
                target="_blank" rel="noopener noreferrer" class="feed-title-link">
                <% if (feedMetadata[feed.id]?.iconUrl) { %>
                  <img src="<%= feedMetadata[feed.id].iconUrl %>" alt="<%= feed.name %> icon" class="feed-icon" />
                  <% } else { let hostname='google.com' ; try { if (feed.url) hostname=new URL(feed.url).hostname; else
                    if (feedMetadata[feed.id]?.siteUrl) hostname=new URL(feedMetadata[feed.id].siteUrl).hostname; }
                    catch (e) {} %>
                    <img src="https://www.google.com/s2/favicons?domain=<%= hostname %>" alt="<%= feed.name %> icon"
                      class="feed-icon" />
                    <% } %>
                      <span class="feed-name"><%= feed.name %></span>
              </a>
            </div>
            <div class="feed-meta">
              <span class="feed-domain">
                <% let domainLabel=''; try { if (feedMetadata[feed.id]?.siteUrl) { domainLabel=new
                  URL(feedMetadata[feed.id].siteUrl).hostname; } else if (feed.url) { domainLabel=new
                  URL(feed.url).hostname; } } catch (e) {} %>
                  <%= domainLabel || 'feed' %>
              </span>
            </div>
          </div>
          <div class="feed-items">
            <% if (itemsByFeed[feed.id] && itemsByFeed[feed.id].length) { %>
              <% itemsByFeed[feed.id].forEach(function(item) { 
                   const usageCategories = (reportUsageMap && reportUsageMap[item.id]) || [];
                   const hasExpandableMedia = item.mediaType === 'image' || item.mediaType === 'video';
                   const itemTags = (item.tags && item.tags.length) ? item.tags : (feed.categories || []);
              %>
                <div class="feed-item" data-sentiment="<%= (item.sentiment || 'unknown').toLowerCase() %>" data-report-categories="<%= usageCategories.map(cat => encodeURIComponent(cat)).join(' ') %>">
                  <% /* Debug info: */ %>
                    <!-- Item ID: <%= item.id %>, sentiment: <%= item.sentiment %> -->
                    <div class="feed-item-header">
                      <div class="feed-item-main">
                        <% if (usageCategories.length) { %>
                          <span class="feed-item-report-star" title="Used in this category's News Brief">‚≠êÔ∏è</span>
                        <% } %>
                        <a href="<%= item.url %>" target="_blank" rel="noopener noreferrer" class="feed-item-link">
                          <%= item.title %>
                        </a>
                        <% if (item.published) { %>
                          <span class="feed-item-date">
                            (<%= formatDate(new Date(item.published)) %>)
                          </span>
                          <% } %>
                              <% if (item.hasSummary) { %>
                                <span class="feed-item-summary-toggle" data-item-id="<%= item.id %>">[toggle ai
                                  summary]</span>
                                <% } else if (item.mediaType==="image" ) { %>
                                  <span class="feed-item-summary-skipped feed-item-media-image feed-item-media-toggle"
                                    data-item-id="<%= item.id %>"
                                    title="Click to toggle embedded image. Click the image to open in new tab.">
                                    [üñºÔ∏è image]
                                  </span>
                                  <% } else if (item.mediaType==="video" && (item.mediaUrl ||
                                    item.url).includes("youtube.com/watch") || (item.mediaUrl ||
                                    item.url).includes("youtu.be/")) { %>
                                    <span class="feed-item-summary-skipped feed-item-media-video feed-item-media-toggle"
                                      data-item-id="<%= item.id %>">
                                      [üé¨ video]
                                    </span>
                                    <% } else if (item.mediaType==="video" ) { %>
                                      <span
                                        class="feed-item-summary-skipped feed-item-media-video feed-item-media-toggle"
                                        data-item-id="<%= item.id %>">
                                        [üé¨ video]
                                      </span>
                                      <% } else if (item.mediaType && !['text', 'short-text' ].includes(item.mediaType))
                                        { %>
                                        <a href="<%= item.mediaUrl || item.url %>" target="_blank"
                                          rel="noopener noreferrer"
                                          class="feed-item-summary-skipped feed-item-media-<%= item.mediaType %>"
                                          data-item-id="<%= item.id %>" title="<%= item.content || 'Media content' %>">
                                          [<%= item.mediaType==="audio" ? "üéµ audio ‚¨ö‚Üó" : item.mediaType==="document"
                                            ? "üìÑ document ‚¨ö‚Üó" : item.mediaType==="archive" ? "üì¶ archive ‚¨ö‚Üó" :
                                            item.mediaType==="error" ? "‚ö†Ô∏è error" : "üíª media ‚¨ö‚Üó" %>]
                                        </a>
                                        <% } else if (item.content && item.content.startsWith('[ERROR:')) { %>
                                          <a href="<%= item.mediaUrl || item.url %>" target="_blank"
                                            rel="noopener noreferrer" class="feed-item-summary-error"
                                            data-item-id="<%= item.id %>" title="<%= item.content %>">[‚ö†Ô∏è error loading
                                            content]</a>
                                          <% } else { %>
                                            <span class="feed-item-summary-not-available"
                                              data-item-id="<%= item.id %>">[no summary available]</span>
                                            <% } %>
                      </div>
                      <% if (itemTags && itemTags.length) { %>
                        <div class="feed-item-tags" aria-label="Tags">
                          <% itemTags.forEach(function(tag) { %>
                            <span class="feed-item-tag"><%= tag %></span>
                          <% }); %>
                        </div>
                      <% } %>
                      <div class="feed-item-actions">
                        <a href="<%= item.url %>" target="_blank" rel="noopener noreferrer"
                          class="feed-item-open-link" aria-label="Open item">
                          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            aria-hidden="true">
                            <path d="M15 3h6v6"></path>
                            <path d="M10 14 21 3"></path>
                            <path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path>
                          </svg>
                        </a>
                        <% if (item.commentsUrl) { %>
                          <a href="<%= item.commentsUrl %>" target="_blank" rel="noopener noreferrer"
                            class="feed-item-comments-link" aria-label="Open Hacker News discussion">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square w-4 h-4 text-orange-500" aria-hidden="true"><path d="M22 17a2 2 0 0 1-2 2H6.828a2 2 0 0 0-1.414.586l-2.202 2.202A.71.71 0 0 1 2 21.286V5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2z"></path></svg>
                          </a>
                        <% } %>
                        <% if (item.sentiment==='Positive') { %>
                          <span class="feed-item-sentiment positive" title="Positive content">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12" aria-hidden="true">
                              <circle cx="6" cy="6" r="5"></circle>
                            </svg>
                          </span>
                        <% } else if (item.sentiment==='Negative') { %>
                          <span class="feed-item-sentiment negative" title="Neutral or negative content">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12" aria-hidden="true">
                              <circle cx="6" cy="6" r="5"></circle>
                            </svg>
                          </span>
                        <% } else if (item.sentiment==='Mixed') { %>
                          <span class="feed-item-sentiment mixed" title="Mixed sentiment">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12" aria-hidden="true">
                              <circle cx="6" cy="6" r="5"></circle>
                            </svg>
                          </span>
                        <% } else { %>
                          <span class="feed-item-sentiment unknown" title="Sentiment not analyzed">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 12" aria-hidden="true">
                              <circle cx="6" cy="6" r="5"></circle>
                            </svg>
                          </span>
                        <% } %>
                        <% if (item.summary || hasExpandableMedia) { %>
                          <span class="feed-item-toggle-icon" aria-hidden="true">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"></path></svg>
                          </span>
                        <% } %>
                      </div>
                    </div>
                    <% if (item.summary) { %>
                      <div class="feed-item-summary" id="summary-<%= item.id %>">
                        <%= item.summary %>
                      </div>
                      <% } %>
                    <% if (item.mediaType==="image" ) { %>
                      <span class="feed-item-media-embed" id="media-<%= item.id %>">
                        <a href="<%= item.mediaUrl || item.url %>" target="_blank" rel="noopener noreferrer">
                          <img src="<%= item.mediaUrl || item.url %>" alt="Embedded image"
                            style="max-width: 400px; max-height: 300px; margin-top: 0.5em; border-radius: 6px; border: 1px solid #ccc; cursor: pointer;">
                        </a>
                      </span>
                    <% } else if (item.mediaType==="video" && (item.mediaUrl ||
                      item.url).includes("youtube.com/watch") || (item.mediaUrl ||
                      item.url).includes("youtu.be/")) { %>
                      <span class="feed-item-media-embed" id="media-<%= item.id %>">
                        <% /* Extract YouTube video ID */ let ytId=null; try { const url=new
                          URL(item.mediaUrl || item.url); if (url.hostname.includes("youtube.com")) {
                          ytId=url.searchParams.get("v"); } else if (url.hostname.includes("youtu.be")) {
                          ytId=url.pathname.replace("/", "" ); } } catch (e) {} %>
                          <% if (ytId) { %>
                            <iframe width="400" height="225"
                              src="https://www.youtube.com/embed/<%= ytId %>" frameborder="0" allowfullscreen
                              style="margin-top: 0.5em; border-radius: 6px; border: 1px solid #ccc;"></iframe>
                            <% } else { %>
                              <a href="<%= item.mediaUrl || item.url %>" target="_blank"
                                rel="noopener noreferrer">Open video</a>
                              <% } %>
                      </span>
                    <% } else if (item.mediaType==="video" ) { %>
                      <span class="feed-item-media-embed" id="media-<%= item.id %>">
                        <video src="<%= item.mediaUrl || item.url %>" controls
                          style="max-width: 400px; max-height: 300px; margin-top: 0.5em; border-radius: 6px; border: 1px solid #ccc;"></video>
                      </span>
                    <% } %>
                </div>
                <% }); %>
                  <% } else { %>
                    <p class="no-items">No recent items found for this feed</p>
                    <% } %>
          </div>
        </div>
        <% }); %>
    </div>

    <div class="footer">
      <p class="source-code"><span>&lt;&gt;</span> <a href="https://github.com/felipesabino/rss" target="_blank"
          rel="noopener noreferrer">source code at GitHub</a></p>
    </div>
  </div>

  <script>
    // Enable debug mode by adding ?debug=true to the URL
    const urlParams = new URLSearchParams(window.location.search);
    const debugMode = urlParams.get('debug') === 'true';

    if (debugMode) {
      console.log('Debug mode enabled');
    }

    // Toggle media embed visibility
    document.addEventListener('DOMContentLoaded', function () {
      const body = document.body;

      document.querySelectorAll('.feed-item-media-toggle').forEach(function (element) {
        element.addEventListener('click', function () {
          const itemId = this.getAttribute('data-item-id');
          const mediaElement = document.getElementById('media-' + itemId);
          if (!mediaElement) {
            return;
          }

          const isList = body.classList.contains('list-layout');

          // In card/grid view, keep media visible by default
          if (!isList) {
            mediaElement.classList.remove('hidden');
            return;
          }

          mediaElement.classList.toggle('hidden');
        });
      });
      // Dark mode toggle functionality
      const darkModeToggle = document.getElementById('darkModeToggle');
      const layoutToggle = document.getElementById('layoutToggle');

      // Check for saved preference
      const isDarkMode = localStorage.getItem('darkMode') === 'true';
      let layoutMode = localStorage.getItem('layoutMode') || 'grid';

      // Set initial state
      if (isDarkMode) {
        body.classList.add('dark-mode');
        darkModeToggle.textContent = '‚òÄÔ∏è';
      }

      applyLayoutMode(layoutMode);

      // Toggle dark mode
      darkModeToggle.addEventListener('click', function () {
        const isDark = body.classList.toggle('dark-mode');
        darkModeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        localStorage.setItem('darkMode', isDark);
      });

      if (layoutToggle) {
        layoutToggle.addEventListener('click', function () {
          layoutMode = layoutMode === 'grid' ? 'list' : 'grid';
          localStorage.setItem('layoutMode', layoutMode);
          applyLayoutMode(layoutMode);
        });
      }

      // Good Vibes Only toggle functionality
      const goodVibesToggle = document.getElementById('goodVibesToggle');
      let goodVibesOnly = localStorage.getItem('goodVibesOnly') === 'true';

      // Set initial state
      if (goodVibesOnly) {
        goodVibesToggle.classList.add('active');
        filterByPositiveSentiment(true);
      } else {
        goodVibesToggle.classList.remove('active');
        filterByPositiveSentiment(false);
      }

      // Toggle good vibes filter
      goodVibesToggle.addEventListener('click', function () {
        goodVibesOnly = !goodVibesOnly;
        this.classList.toggle('active', goodVibesOnly);
        localStorage.setItem('goodVibesOnly', goodVibesOnly);
        filterByPositiveSentiment(goodVibesOnly);
      });

      // Function to filter items by sentiment
      function filterByPositiveSentiment(showOnlyPositive) {
        if (debugMode) {
          console.log(`Filtering items, showOnlyPositive: ${showOnlyPositive}`);
        }

        const feedItems = document.querySelectorAll('.feed-item');
        let positiveCount = 0;
        let negativeCount = 0;

        feedItems.forEach(function (item) {
          const sentiment = (item.getAttribute('data-sentiment') || '').toLowerCase();
          const isPositive = sentiment === 'positive';

          if (debugMode) {
            const itemTitle = item.querySelector('.feed-item-link').textContent.trim();
            console.log(`Item: "${itemTitle.substring(0, 30)}...", sentiment: ${sentiment}`);
          }

          if (isPositive) {
            positiveCount++;
          } else {
            negativeCount++;
          }

          if (showOnlyPositive) {
            if (isPositive) {
              item.style.display = '';
            } else {
              item.style.display = 'none';
            }
          } else {
            item.style.display = '';
          }
        });

        if (debugMode) {
          console.log(`Total items: ${feedItems.length}, Positive: ${positiveCount}, Negative/Neutral: ${negativeCount}`);
        }

        // Show/hide "no items" message for feeds
        document.querySelectorAll('.feed').forEach(function (feed) {
          const feedTitle = feed.querySelector('.feed-title-link').textContent.trim();

          // Count visible items correctly by checking display property
          const allItems = Array.from(feed.querySelectorAll('.feed-item'));
          const visibleItems = allItems.filter(item => item.style.display !== 'none');

          if (debugMode) {
            console.log(`Feed: "${feedTitle}", Total items: ${allItems.length}, Visible items: ${visibleItems.length}`);
          }

          const feedItems = feed.querySelector('.feed-items');

          if (visibleItems.length === 0 && showOnlyPositive) {
            // Create "no positive items" message if it doesn't exist
            let noPositiveItems = feed.querySelector('.no-positive-items');
            if (!noPositiveItems) {
              noPositiveItems = document.createElement('p');
              noPositiveItems.className = 'no-positive-items';
              noPositiveItems.textContent = 'No positive items found for this feed';
              feedItems.appendChild(noPositiveItems);
            }
            noPositiveItems.style.display = '';
          } else {
            // Hide "no positive items" message if it exists
            const noPositiveItems = feed.querySelector('.no-positive-items');
            if (noPositiveItems) {
              noPositiveItems.style.display = 'none';
            }
          }
        });
      }

      function applyLayoutMode(mode) {
        const isList = mode === 'list';
        body.classList.toggle('list-layout', isList);
        updateSummariesForLayout(isList);
        updateMediaForLayout(isList);
        setupListExpansion();
        if (layoutToggle) {
          layoutToggle.textContent = isList ? 'Card View' : 'List View';
          layoutToggle.classList.toggle('active', isList);
          layoutToggle.setAttribute('aria-pressed', isList ? 'true' : 'false');
        }
      }

      function updateSummariesForLayout(isList) {
        const toggles = document.querySelectorAll('.feed-item-summary-toggle');
        const summaries = document.querySelectorAll('.feed-item-summary');
        const feedItems = document.querySelectorAll('.feed-item');

        // Hide legacy text toggles in all layouts
        toggles.forEach(toggle => toggle.classList.add('hidden'));

        // Ensure summaries are present for animation-based show/hide
        summaries.forEach(summary => summary.classList.remove('hidden'));

        // Default collapsed in list layout, fully expanded in grid/card
        if (!isList) {
          feedItems.forEach(item => item.classList.remove('expanded'));
        } else {
          feedItems.forEach(item => item.classList.remove('expanded'));
        }
      }

      function updateMediaForLayout(isList) {
        const mediaEmbeds = document.querySelectorAll('.feed-item-media-embed');
        mediaEmbeds.forEach(embed => {
          // Always surface media in card/grid view
          if (!isList) {
            embed.classList.remove('hidden');
            return;
          }

          // For list view, collapse by default (CSS handles transition),
          // but ensure any lingering hidden class does not block expansion.
          embed.classList.remove('hidden');
        });
      }

      function setupListExpansion() {
        const isList = body.classList.contains('list-layout');

        document.querySelectorAll('.feed-item').forEach(item => {
          const header = item.querySelector('.feed-item-header');
          const summary = item.querySelector('.feed-item-summary');
          const mediaEmbed = item.querySelector('.feed-item-media-embed');
          const toggleIcon = item.querySelector('.feed-item-toggle-icon');
          const isExpandable = Boolean(summary || mediaEmbed);

          if (!header || !isExpandable) {
            return;
          }

          // Only show the chevron in list layout
          if (toggleIcon) {
            toggleIcon.style.visibility = isList ? 'visible' : 'hidden';
          }

          if (item.dataset.summaryBound === 'true') {
            return;
          }
          item.dataset.summaryBound = 'true';

          header.addEventListener('click', function (evt) {
            if (!body.classList.contains('list-layout')) {
              return;
            }

            const clickedToggle = evt.target.closest('.feed-item-toggle-icon');
            const clickedActionLink = evt.target.closest('.feed-item-actions a');
            const clickedSentiment = evt.target.closest('.feed-item-sentiment');
            const clickedTitleLink = evt.target.closest('.feed-item-link');

            if (clickedActionLink || clickedSentiment || clickedTitleLink) {
              return;
            }

            if (clickedToggle) {
              item.classList.toggle('expanded');
              return;
            }

            // Allow header clicks (outside of links/icons) to toggle
            item.classList.toggle('expanded');
          });
        });
      }

      // Category filter functionality
      const categoryItems = document.querySelectorAll('.category-item');
      const feeds = document.querySelectorAll('.feed');

      // Report functionality
      const reportToggleContainer = document.getElementById('reportToggleContainer');
      const reportContainer = document.getElementById('reportContainer');
      const categoryReports = document.querySelectorAll('.category-report');
      const noReportMessage = document.getElementById('noReportMessage');

      let showReport = localStorage.getItem('showReport') === 'true';
      let activeReportCategory = localStorage.getItem('activeReportCategory');
      if (activeReportCategory === 'null' || activeReportCategory === 'undefined') {
        activeReportCategory = null;
      }

      // Get selected categories from localStorage or default to ['all']
      let selectedCategories = [];
      try {
        const savedCategories = localStorage.getItem('selectedCategories');
        selectedCategories = savedCategories ? JSON.parse(savedCategories) : ['all'];
      } catch (e) {
        selectedCategories = ['all'];
      }

      function setActiveReportCategory(category) {
        activeReportCategory = category;
        if (category) {
          localStorage.setItem('activeReportCategory', category);
        } else {
          localStorage.removeItem('activeReportCategory');
        }
      }

      function formatCategoryLabel(category) {
        if (!category) {
          return '';
        }
        return category.charAt(0).toUpperCase() + category.slice(1);
      }

      function handleReportButtonClick(category) {
        if (activeReportCategory === category && showReport) {
          showReport = false;
        } else {
          showReport = true;
          setActiveReportCategory(category);
        }

        localStorage.setItem('showReport', showReport);
        updateReportDisplay();
      }

      function renderReportButtons(categories) {
        reportToggleContainer.innerHTML = '';

        const hasSpecificCategories = Array.isArray(categories) && !categories.includes('all');
        if (!hasSpecificCategories) {
          reportToggleContainer.classList.add('hidden');
          reportContainer.classList.add('hidden');
          setActiveReportCategory(null);
          updateReportIndicators(null);
          return;
        }

        const orderedSelected = Array.from(categoryItems)
          .map(item => item.getAttribute('data-category'))
          .filter(cat => cat && cat !== 'all' && categories.includes(cat));

        if (!orderedSelected.length) {
          reportToggleContainer.classList.add('hidden');
          reportContainer.classList.add('hidden');
          setActiveReportCategory(null);
          updateReportIndicators(null);
          return;
        }

        if (!orderedSelected.includes(activeReportCategory)) {
          setActiveReportCategory(orderedSelected[0]);
        }

        orderedSelected.forEach(cat => {
          const button = document.createElement('button');
          button.className = 'report-toggle-btn';
          button.setAttribute('data-category', cat);
          button.textContent = `Show ${formatCategoryLabel(cat)} Report üì∞`;
          button.addEventListener('click', () => handleReportButtonClick(cat));
          reportToggleContainer.appendChild(button);
        });

        reportToggleContainer.classList.remove('hidden');
        updateReportDisplay();
      }

      function updateReportDisplay() {
        const buttons = reportToggleContainer.querySelectorAll('.report-toggle-btn');
        buttons.forEach(button => {
          const buttonCategory = button.getAttribute('data-category');
          button.classList.toggle('active', showReport && buttonCategory === activeReportCategory);
        });

        categoryReports.forEach(report => report.classList.add('hidden'));
        if (noReportMessage) {
          noReportMessage.classList.add('hidden');
        }

        if (showReport && activeReportCategory) {
          const targetReport = document.querySelector(`.category-report[data-category="${activeReportCategory}"]`);
          if (targetReport) {
            targetReport.classList.remove('hidden');
            reportContainer.classList.remove('hidden');
          } else if (noReportMessage) {
            noReportMessage.classList.remove('hidden');
            reportContainer.classList.remove('hidden');
          } else {
            reportContainer.classList.add('hidden');
          }
        } else {
          reportContainer.classList.add('hidden');
        }

        updateReportIndicators(showReport ? activeReportCategory : null);
      }

      // Function to filter feeds by categories
      function filterFeeds(categories) {
        // If 'all' is selected, clear other selections
        if (categories.includes('all')) {
          categories = ['all'];
        }

        // If no categories are selected, default to 'all'
        if (categories.length === 0) {
          categories = ['all'];
        }

        // Update active state on category items
        categoryItems.forEach(item => {
          const itemCategory = item.getAttribute('data-category');
          if (categories.includes(itemCategory)) {
            item.classList.add('active');
          } else {
            item.classList.remove('active');
          }
        });

        // Show/hide feeds based on selected categories
        feeds.forEach(feed => {
          if (categories.includes('all')) {
            feed.style.display = '';
          } else {
            const feedCategories = feed.getAttribute('data-categories').split(' ').map(cat => decodeURIComponent(cat));
            // Show feed if it matches ANY of the selected categories
            const hasMatchingCategory = feedCategories.some(cat => categories.includes(cat));
            feed.style.display = hasMatchingCategory ? '' : 'none';
          }
        });

        // Update report visibility
        updateReportVisibility(categories);

        // Save selection to localStorage
        localStorage.setItem('selectedCategories', JSON.stringify(categories));
      }

      function updateReportVisibility(categories) {
        renderReportButtons(categories);
      }

      function updateReportIndicators(activeCategory) {
        const feedItems = document.querySelectorAll('.feed-item');
        feedItems.forEach(item => item.classList.remove('used-in-active-report'));

        if (!showReport || !activeCategory) {
          return;
        }

        const normalizedCategory = activeCategory.toLowerCase();

        feedItems.forEach(item => {
          const attr = item.getAttribute('data-report-categories') || '';
          if (!attr) {
            return;
          }

          const categories = attr
            .split(' ')
            .filter(Boolean)
            .map(encoded => {
              try {
                return decodeURIComponent(encoded).toLowerCase();
              } catch (e) {
                return encoded.toLowerCase();
              }
            });

          if (categories.includes(normalizedCategory)) {
            item.classList.add('used-in-active-report');
          }
        });
      }

      // Apply initial filter based on saved preference
      filterFeeds(selectedCategories);

      // Add click event listeners to category items
      categoryItems.forEach(item => {
        item.addEventListener('click', function () {
          const category = this.getAttribute('data-category');

          // Handle 'all' category specially
          if (category === 'all') {
            selectedCategories = ['all'];
          } else {
            // Remove 'all' if it's currently selected
            if (selectedCategories.includes('all')) {
              selectedCategories = [];
            }

            // Toggle the selected category
            if (selectedCategories.includes(category)) {
              selectedCategories = selectedCategories.filter(cat => cat !== category);
            } else {
              selectedCategories.push(category);
            }
          }

          filterFeeds(selectedCategories);
        });
      });
    });
  </script>
</body>

</html>
